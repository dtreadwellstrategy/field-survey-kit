from fastapi import FastAPI
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel

app = FastAPI()

# Serve static files like HTML, JS, CSS
app.mount("/static", StaticFiles(directory="static"), name="static")

# Route to show the Terms of Use page
@app.get("/", response_class=HTMLResponse)
async def nda():
    with open("static/index.html") as f:
        return HTMLResponse(content=f.read())

# Route to show the form with the map
@app.get("/form", response_class=HTMLResponse)
async def form():
    with open("static/form.html") as f:
        return HTMLResponse(content=f.read())

# Define what kind of data your form will submit
class SurveySubmission(BaseModel):
    name: str
    property: str
    notes: str
    lat: float
    lng: float
    timestamp: str
    ua: str
    geojson: str  # This allows collecting map features

# Route to receive and log submissions
@app.post("/log")
async def log_location(data: SurveySubmission):
    print("Received data:", data)  # âœ… Shows up in Render logs
    with open("location_log.csv", "a") as f:
        f.write(f"{data.timestamp},{data.name},{data.property},{data.lat},{data.lng},{data.notes},{data.ua},{data.geojson}\n")
    return {"status": "ok"}
