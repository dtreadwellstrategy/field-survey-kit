<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Field Survey</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; }
    #container { display: flex; flex-direction: row; height: 100vh; }
    #map { flex: 2; height: 100%; }
    #form { flex: 1; padding: 20px; background-color: #f7f7f7; overflow-y: auto; }
    input, textarea, button, select {
      display: block; width: 100%; padding: 10px; margin-bottom: 15px; font-size: 14px;
    }
    label { font-weight: bold; }
    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #map { height: 50vh; }
    }
    #labelModal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 9999; display: none;
    }
    #labelModal h3 { margin-top: 0; }
    #labelModal button { margin-top: 10px; }
  </style>
</head>
<body>
<div id="container">
  <div id="map"></div>
  <div id="form">
    <h2>Submit Report</h2>
    <form id="surveyForm">
      <label>Name *</label>
      <input type="text" name="name" required />

      <label>Property *</label>
      <input type="text" name="property" required />

      <label>Notes</label>
      <textarea name="notes" rows="4"></textarea>

      <input type="hidden" name="lat" />
      <input type="hidden" name="lng" />
      <input type="hidden" name="timestamp" />
      <input type="hidden" name="ua" />
      <input type="hidden" name="geojson" />

      <button type="submit">Submit</button>
    </form>
  </div>
</div>

<div id="labelModal">
  <h3>Select Feature Label</h3>
  <select id="labelSelect">
    <!-- All your optgroups stay the same -->
    <optgroup label="Equestrian Facilities">
      <option value="Stable">Stable</option>
      <option value="Paddock">Paddock</option>
      <option value="Arena">Arena</option>
      <option value="Tack Room">Tack Room</option>
      <option value="Round Pen">Round Pen</option>
      <option value="Mounting Block">Mounting Block</option>
      <option value="Cross Country Jump">Cross Country Jump</option>
      <option value="Dressage Letters">Dressage Letters</option>
      <option value="Wash Rack">Wash Rack</option>
      <option value="Hay Storage">Hay Storage</option>
    </optgroup>
    <!-- Remaining optgroups omitted for brevity -->
  </select>
  <button id="confirmLabel">Confirm</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script>
  const map = L.map('map').setView([0, 0], 2);
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/' +
    'World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: 'Tiles © Esri'
  });

  const baseLayers = {
    "Street Map": osm,
    "Satellite": satellite
  };

  L.control.layers(baseLayers, null, { position: 'bottomleft' }).addTo(map);

  const drawControl = new L.Control.Draw({
    draw: {
      polygon: true, rectangle: true, marker: true,
      circle: false, circlemarker: false, polyline: false
    },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  const locateControl = L.control.locate({
    position: 'topleft',
    setView: true,
    keepCurrentZoomLevel: false,
    drawCircle: true,
    showCompass: false,
    markerStyle: { weight: 2, opacity: 0.8, fillOpacity: 0.8 },
    circleStyle: { weight: 1, clickable: false },
    strings: { title: "Show my location" },
    locateOptions: { enableHighAccuracy: true }
  }).addTo(map);

  let pendingLayer = null;

  map.on(L.Draw.Event.CREATED, function (e) {
    pendingLayer = e.layer;
    document.getElementById("labelModal").style.display = "block";
  });

  document.getElementById("confirmLabel").addEventListener("click", () => {
    const label = document.getElementById("labelSelect").value;
    if (pendingLayer && label) {
      pendingLayer.bindPopup(label);
      pendingLayer.feature = {
        type: "Feature",
        properties: { label: label }
      };
      drawnItems.addLayer(pendingLayer);
      pendingLayer = null;
      document.getElementById("labelModal").style.display = "none";
    }
  });

  window.addEventListener("load", function () {
    const ua = navigator.userAgent;
    const timestamp = new Date().toISOString();

    map.locate({ setView: true, maxZoom: 17, enableHighAccuracy: true });

    map.on('locationfound', function (e) {
      const lat = e.latitude;
      const lng = e.longitude;

      document.querySelector('input[name="lat"]').value = lat;
      document.querySelector('input[name="lng"]').value = lng;
      document.querySelector('input[name="timestamp"]').value = timestamp;
      document.querySelector('input[name="ua"]').value = ua;

      fetch("/log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: "PRE-LOCATION",
          property: "PRE-LOCATION",
          notes: "",
          lat: lat,
          lng: lng,
          timestamp: timestamp,
          ua: ua,
          geojson: "{}"
        })
      }).then(res => {
        if (!res.ok) console.warn("Pre-location ping failed.");
      });
    });

    map.on('locationerror', function (err) {
      alert("Location could not be determined: " + err.message);
    });

    locateControl.start();
  });

  document.getElementById("surveyForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const geojson = drawnItems.toGeoJSON();
    if (!geojson.features.length) {
      alert("Please draw at least one feature on the map.");
      return;
    }

    document.querySelector('input[name="geojson"]').value = JSON.stringify(geojson);

    const formData = new FormData(this);
    const payload = {};
    formData.forEach((v, k) => payload[k] = v);

    document.querySelector("button[type='submit']").disabled = true;

    const res = await fetch("/log", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("Survey submitted. Thank you!");
      this.reset();
      drawnItems.clearLayers();
    } else {
      alert("Submission failed.");
    }

    document.querySelector("button[type='submit']").disabled = false;
  });
</script>
</body>
</html>
